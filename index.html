<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOVI Growth Intelligence</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const mockGoogleAdsData = {
          thisWeek: {
            spend: 4250,
            clicks: 892,
            impressions: 45600,
            conversions: 34,
            ctr: 1.96,
            cpc: 4.76,
            cpa: 125.00,
            roas: 2.8
          },
          lastWeek: {
            spend: 3980,
            clicks: 945,
            impressions: 43200,
            conversions: 38,
            ctr: 2.19,
            cpc: 4.21,
            cpa: 104.74,
            roas: 3.2
          }
        };

        const mockCompetitorData = [
          {
            competitor: "Competitor A",
            theme: "Free trial + onboarding support",
            format: "Video testimonials",
            frequency: "High (seen 8x this week)"
          },
          {
            competitor: "Competitor B",
            theme: "ROI calculator + case studies",
            format: "Carousel ads with stats",
            frequency: "Medium (seen 4x this week)"
          },
          {
            competitor: "Competitor C",
            theme: "Integration partnerships emphasis",
            format: "Static image + CTA",
            frequency: "Low (seen 2x this week)"
          }
        ];

        const ToviDashboard = () => {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [passwordInput, setPasswordInput] = useState('');
          const [passwordError, setPasswordError] = useState(false);
          const [metaAdsData, setMetaAdsData] = useState(null);
          const [googleAdsData, setGoogleAdsData] = useState(mockGoogleAdsData);
          const [loading, setLoading] = useState(true);
          const [analysis, setAnalysis] = useState(null);
          const [analyzingLoading, setAnalyzingLoading] = useState(false);
          const [error, setError] = useState(null);

          const handlePasswordSubmit = (e) => {
            e.preventDefault();
            if (passwordInput === 'tovi123') {
              setIsAuthenticated(true);
              setPasswordError(false);
            } else {
              setPasswordError(true);
            }
          };

          useEffect(() => {
            fetchMetaAdsData();
          }, []);

          const fetchMetaAdsData = async () => {
            try {
              const response = await fetch('/api/meta-ads');
              const data = await response.json();
              
              if (data.error || !data.success) {
                console.error('Meta Ads API Error:', data.error || data);
                setMetaAdsData(null);
              } else if (data.metaResponse && data.metaResponse.error) {
                console.error('Meta API returned error:', data.metaResponse.error);
                setMetaAdsData(null);
              } else {
                setMetaAdsData(data);
              }
            } catch (err) {
              console.error('Error fetching Meta Ads data:', err);
              setMetaAdsData(null);
            } finally {
              setLoading(false);
            }
          };

          const runAnalysis = async () => {
            setAnalyzingLoading(true);
            setError(null);

            const systemPrompt = `You are the TOVI Growth Intelligence Assistant.
Your job is to analyze weekly Google Ads and Meta Ads performance data alongside competitor advertising activity and provide clear, actionable growth recommendations.

PRIMARY OBJECTIVES:
1. Diagnose paid media performance (what's working, what's wasting spend, what changed week-over-week).
2. Identify patterns in competitor messaging, formats, and offers.
3. Compare TOVI's strategy to competitors and surface opportunities.
4. Recommend concrete actions for the coming week.

WHEN ANALYZING STATS:
- Focus on CTR, CPC, CPA, ROAS, spend efficiency, and creative fatigue.
- Call out inefficiencies and likely causes.
- Avoid generic advice — every recommendation must be specific and actionable.

WHEN ANALYZING COMPETITORS:
- Look for repeated themes (a signal something is working).
- Identify underused angles TOVI could test.
- Do NOT assume access to competitor spend numbers.

OUTPUT FORMAT (always use this):
1. TL;DR (2–3 bullets)
2. Performance Snapshot (Google + Meta)
3. Competitor Watch
4. What TOVI Should Do Next (prioritized actions)
5. Tests & Questions for the Week

TONE:
Clear, confident, operator-level.
No fluff. No marketing buzzwords.
Write in plain English suitable for an executive email.`;

            const defaultData = {
              thisWeek: { spend: 0, clicks: 0, impressions: 0, conversions: 0, ctr: 0, cpc: 0, cpa: 0, roas: 0 },
              lastWeek: { spend: 0, clicks: 0, impressions: 0, conversions: 0, ctr: 0, cpc: 0, cpa: 0, roas: 0 }
            };

            const metaData = (metaAdsData && metaAdsData.thisWeek && metaAdsData.lastWeek) ? metaAdsData : defaultData;

            const dataPrompt = `Analyze this week's paid media performance:

GOOGLE ADS - THIS WEEK:
- Spend: $${googleAdsData.thisWeek.spend}
- Clicks: ${googleAdsData.thisWeek.clicks}
- Impressions: ${googleAdsData.thisWeek.impressions.toLocaleString()}
- Conversions: ${googleAdsData.thisWeek.conversions}
- CTR: ${googleAdsData.thisWeek.ctr}%
- CPC: $${googleAdsData.thisWeek.cpc}
- CPA: $${googleAdsData.thisWeek.cpa}
- ROAS: ${googleAdsData.thisWeek.roas}x

GOOGLE ADS - LAST WEEK:
- Spend: $${googleAdsData.lastWeek.spend}
- Clicks: ${googleAdsData.lastWeek.clicks}
- Impressions: ${googleAdsData.lastWeek.impressions.toLocaleString()}
- Conversions: ${googleAdsData.lastWeek.conversions}
- CTR: ${googleAdsData.lastWeek.ctr}%
- CPC: $${googleAdsData.lastWeek.cpc}
- CPA: $${googleAdsData.lastWeek.cpa}
- ROAS: ${googleAdsData.lastWeek.roas}x

META ADS - THIS WEEK:
- Spend: $${metaData.thisWeek.spend}
- Clicks: ${metaData.thisWeek.clicks}
- Impressions: ${metaData.thisWeek.impressions.toLocaleString()}
- Conversions: ${metaData.thisWeek.conversions}
- CTR: ${metaData.thisWeek.ctr}%
- CPC: $${metaData.thisWeek.cpc}
- CPA: $${metaData.thisWeek.cpa}
- ROAS: ${metaData.thisWeek.roas}x

META ADS - LAST WEEK:
- Spend: $${metaData.lastWeek.spend}
- Clicks: ${metaData.lastWeek.clicks}
- Impressions: ${metaData.lastWeek.impressions.toLocaleString()}
- Conversions: ${metaData.lastWeek.conversions}
- CTR: ${metaData.lastWeek.ctr}%
- CPC: $${metaData.lastWeek.cpc}
- CPA: $${metaData.lastWeek.cpa}
- ROAS: ${metaData.lastWeek.roas}x

COMPETITOR INTELLIGENCE:
${mockCompetitorData.map(c => `- ${c.competitor}: ${c.theme} | Format: ${c.format} | ${c.frequency}`).join('\n')}

Provide your analysis following the exact output format specified in your instructions.`;

            try {
              const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  systemPrompt: systemPrompt,
                  dataPrompt: dataPrompt
                })
              });

              const data = await response.json();
              
              if (data.content && data.content[0]?.text) {
                setAnalysis(data.content[0].text);
              } else {
                setError('Unable to generate analysis. Please try again.');
              }
            } catch (err) {
              setError('Error connecting to analysis engine: ' + err.message);
            } finally {
              setAnalyzingLoading(false);
            }
          };

          const MetricCard = ({ title, thisWeek, lastWeek, format = 'number', inverse = false }) => {
            const change = lastWeek !== 0 ? ((thisWeek - lastWeek) / lastWeek * 100).toFixed(1) : 0;
            const isPositive = inverse ? change < 0 : change > 0;
            
            const formatValue = (val) => {
              if (format === 'currency') return `$${val.toFixed(2)}`;
              if (format === 'percent') return `${val}%`;
              if (format === 'multiplier') return `${val}x`;
              return val.toLocaleString();
            };

            const Arrow = ({ direction }) => (
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                {direction === 'up' ? (
                  <path d="M12 19V5M5 12l7-7 7 7"/>
                ) : (
                  <path d="M12 5v14M5 12l7 7 7-7"/>
                )}
              </svg>
            );

            return (
              <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <div className="text-sm text-gray-600 mb-1">{title}</div>
                <div className="text-2xl font-bold text-gray-900">{formatValue(thisWeek)}</div>
                <div className={`text-sm flex items-center mt-1 ${isPositive ? 'text-green-600' : 'text-red-600'}`}>
                  <Arrow direction={isPositive ? 'up' : 'down'} />
                  <span className="ml-1">{Math.abs(change)}% vs last week</span>
                </div>
              </div>
            );
          };

          const defaultData = {
            thisWeek: { spend: 0, clicks: 0, impressions: 0, conversions: 0, ctr: 0, cpc: 0, cpa: 0, roas: 0 },
            lastWeek: { spend: 0, clicks: 0, impressions: 0, conversions: 0, ctr: 0, cpc: 0, cpa: 0, roas: 0 }
          };
          
          const displayMetaData = metaAdsData && metaAdsData.thisWeek && metaAdsData.lastWeek ? metaAdsData : defaultData;

          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-6">
                <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                  <div className="text-center mb-6">
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">TOVI Growth Intelligence</h1>
                    <p className="text-gray-600">Enter password to access dashboard</p>
                  </div>
                  <form onSubmit={handlePasswordSubmit}>
                    <input
                      type="password"
                      value={passwordInput}
                      onChange={(e) => setPasswordInput(e.target.value)}
                      placeholder="Enter password"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4"
                      autoFocus
                    />
                    {passwordError && (
                      <p className="text-red-600 text-sm mb-4">Incorrect password. Please try again.</p>
                    )}
                    <button
                      type="submit"
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                    >
                      Access Dashboard
                    </button>
                  </form>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50 p-6">
              <div className="max-w-7xl mx-auto">
                <div className="mb-8">
                  <h1 className="text-3xl font-bold text-gray-900 mb-2">TOVI Growth Intelligence</h1>
                  <p className="text-gray-600">Weekly paid media performance & competitor analysis</p>
                  {!metaAdsData && !loading && (
                    <p className="text-sm text-orange-600 mt-2">⚠ Using mock Meta Ads data (API connection issue)</p>
                  )}
                </div>

                <div className="mb-6">
                  <button
                    onClick={runAnalysis}
                    disabled={analyzingLoading}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                  >
                    {analyzingLoading ? 'Analyzing...' : 'Run Weekly Analysis'}
                  </button>
                </div>

                <div className="mb-6">
                  <h2 className="text-xl font-bold text-gray-900 mb-4">Google Ads Performance</h2>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <MetricCard title="Spend" thisWeek={googleAdsData.thisWeek.spend} lastWeek={googleAdsData.lastWeek.spend} format="currency" inverse={true} />
                    <MetricCard title="CTR" thisWeek={googleAdsData.thisWeek.ctr} lastWeek={googleAdsData.lastWeek.ctr} format="percent" />
                    <MetricCard title="CPA" thisWeek={googleAdsData.thisWeek.cpa} lastWeek={googleAdsData.lastWeek.cpa} format="currency" inverse={true} />
                    <MetricCard title="ROAS" thisWeek={googleAdsData.thisWeek.roas} lastWeek={googleAdsData.lastWeek.roas} format="multiplier" />
                  </div>
                </div>

                <div className="mb-6">
                  <h2 className="text-xl font-bold text-gray-900 mb-4">
                    Meta Ads Performance 
                    {metaAdsData && <span className="text-green-600 text-sm ml-2">✓ Live Data</span>}
                  </h2>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <MetricCard title="Spend" thisWeek={displayMetaData.thisWeek.spend} lastWeek={displayMetaData.lastWeek.spend} format="currency" inverse={true} />
                    <MetricCard title="CTR" thisWeek={displayMetaData.thisWeek.ctr} lastWeek={displayMetaData.lastWeek.ctr} format="percent" />
                    <MetricCard title="CPA" thisWeek={displayMetaData.thisWeek.cpa} lastWeek={displayMetaData.lastWeek.cpa} format="currency" inverse={true} />
                    <MetricCard title="ROAS" thisWeek={displayMetaData.thisWeek.roas} lastWeek={displayMetaData.lastWeek.roas} format="multiplier" />
                  </div>
                </div>

                <div className="mb-6">
                  <h2 className="text-xl font-bold text-gray-900 mb-4">Competitor Watch</h2>
                  <div className="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Competitor</th>
                          <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Theme</th>
                          <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Format</th>
                          <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Frequency</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {mockCompetitorData.map((comp, idx) => (
                          <tr key={idx}>
                            <td className="px-4 py-3 text-sm font-medium text-gray-900">{comp.competitor}</td>
                            <td className="px-4 py-3 text-sm text-gray-700">{comp.theme}</td>
                            <td className="px-4 py-3 text-sm text-gray-700">{comp.format}</td>
                            <td className="px-4 py-3 text-sm text-gray-700">{comp.frequency}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                {error && (
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div className="flex items-start">
                      <span className="text-red-600 mr-2">⚠</span>
                      <div className="text-red-800">{error}</div>
                    </div>
                  </div>
                )}

                {analysis && (
                  <div className="bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div className="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 rounded-t-lg">
                      <div className="flex items-center">
                        <span className="text-white mr-2 text-xl">✓</span>
                        <h2 className="text-xl font-bold text-white">Intelligence Report</h2>
                      </div>
                    </div>
                    <div className="p-6">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {(() => {
                          const sections = analysis.split(/###\s*\d+\.\s+|^\d+\.\s+/m).filter(s => s.trim());
                          
                          return sections.map((section, idx) => {
                            const lines = section.trim().split('\n');
                            let title = lines[0].trim();
                            
                            title = title
                              .replace(/^\*+|\*+$/g, '')
                              .replace(/^#+\s*/, '')
                              .replace(/\*\*/g, '')
                              .trim();
                            
                            const content = lines.slice(1)
                              .map(line => line.trim())
                              .filter(line => line && !line.match(/^-{3,}$/))
                              .map(line => {
                                return line
                                  .replace(/^\*+\s*/g, '')
                                  .replace(/\*\*/g, '')
                                  .replace(/^-\s*/g, '')
                                  .replace(/^•\s*/g, '')
                                  .trim();
                              })
                              .filter(line => line)
                              .join(' ');
                            
                            if (!title || !content) return null;
                            
                            return (
                              <div key={idx} className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200 hover:shadow-lg transition-shadow">
                                <h3 className="text-base font-bold text-blue-700 mb-3 pb-2 border-b-2 border-blue-300">
                                  {title}
                                </h3>
                                <div className="text-sm text-gray-700 leading-relaxed">
                                  <p className="whitespace-pre-line">{content}</p>
                                </div>
                              </div>
                            );
                          }).filter(Boolean);
                        })()}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(React.createElement(ToviDashboard), document.getElementById('root'));
    </script>
</body>
</html>
